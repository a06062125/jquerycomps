(function(c){Bizs.FormLogic=d;function d(a){a&&(a=c(a));if(d.getInstance(a)){return d.getInstance(a)}d.getInstance(a,this);this._model=new d.Model(a);this._view=new d.View(this._model);this._init()}d.getInstance=function(b,a){if(typeof b=="string"&&!/</.test(b)){b=c(b)}if(!(b&&b.length)||(typeof b=="string")){return}typeof a!="undefined"&&b.data("FormLogicIns",a);return b.data("FormLogicIns")};!JC.Valid&&JC.use("Valid");!JC.Form&&JC.use("Form");!JC.Panel&&JC.use("Panel");!c(document).ajaxForm&&JC.use("plugins.jquery.form");d.init=function(b){var a=[];b&&(b=c(b));if(!(b&&b.length)){return}if(b.prop("nodeName").toLowerCase()=="form"){a.push(new d(b))}else{b.find("form.js_bizsFormLogic, form.js_autoFormLogic").each(function(){a.push(new d(this))})}return a};d.popupCloseMs=2000;d.formSubmitType="";d.submitDisable=true;d.resetAfterSubmit=true;d.prototype={_beforeInit:function(){},_initHanlderEvent:function(){var b=this,a=b._model.formType();b._view.initQueryVal();b.selector().on("submit",function(f){b._model.isSubmited(true);if(b._model.formBeforeProcess()){if(b._model.formBeforeProcess().call(b.selector(),f,b)===false){return b._model.prevent(f)}}if(!JC.Valid.check(b.selector())){return b._model.prevent(f)}if(b._model.formAfterProcess()){if(b._model.formAfterProcess().call(b.selector(),f,b)===false){return b._model.prevent(f)}}if(b.selector().data(d.Model.SUBMIT_CONFIRM_BUTTON)){b.trigger(d.Model.EVT_CONFIRM);return b._model.prevent(f)}b.trigger("ProcessDone")});b.on("BindFrame",function(k){var i,j=b._model.formType(),l;if(j!=d.Model.AJAX){return}i=b._model.frame();i.on("load",function(f){var e=i.prop("contentWindow"),g=e.document.body,h=c.trim(g.innerHTML);if(!b._model.isSubmited()){return}JC.log("common ajax done");b.trigger("AjaxDone",[h])})});b.on("AjaxDone",function(s,o){var r=b._model.selector().find("button[type=reset], input[type=reset]");b._model.formSubmitDisable()&&b.trigger("EnableSubmit");var t,p,m=b._model.formAjaxResultType();if(m=="json"){try{t=c.parseJSON(o)}catch(q){p=true;t=o}}if(p){var n=printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',o);JC.Dialog.alert(n,1);return}t&&m=="json"&&"errorno" in t&&!parseInt(t.errorno,10)&&b._model.formResetAfterSubmit()&&r.length&&b.selector().trigger("reset");t=t||o||{};b._model.formAjaxDone()&&b._model.formAjaxDone().call(b._model.selector(),t,b._model.selector().data(d.Model.GENERIC_SUBMIT_BUTTON),b);b._model.formResetAfterSubmit()&&!b._model.userFormAjaxDone()&&r.length&&b.selector().trigger("reset")});b.on("ProcessDone",function(){b._model.formSubmitDisable()&&b.selector().find("input[type=submit], button[type=submit]").each(function(){c(this).prop("disabled",true)})});b.on(d.Model.EVT_CONFIRM,function(j){var i=b.selector().data(d.Model.SUBMIT_CONFIRM_BUTTON);i&&(i=c(i));if(!(i&&i.length)){return}var h;if(b._model.formConfirmPopupType(i)=="dialog"){h=JC.Dialog.confirm(b._model.formSubmitConfirm(i),2)}else{h=JC.confirm(b._model.formSubmitConfirm(i),i,2)}h.on("confirm",function(){b.selector().data(d.Model.SUBMIT_CONFIRM_BUTTON,null);b.selector().trigger("submit")});h.on("close",function(){b.selector().data(d.Model.SUBMIT_CONFIRM_BUTTON,null)})});b.selector().on("reset",function(f){if(b.selector().data(d.Model.RESET_CONFIRM_BUTTON)){b.trigger(d.Model.EVT_RESET);return b._model.prevent(f)}else{b._view.reset();b.trigger("EnableSubmit")}});b.on("EnableSubmit",function(){b.selector().find("input[type=submit], button[type=submit]").each(function(){c(this).prop("disabled",false)})});b.on(d.Model.EVT_RESET,function(j){var i=b.selector().data(d.Model.RESET_CONFIRM_BUTTON);i&&(i=c(i));if(!(i&&i.length)){return}var h;if(b._model.formConfirmPopupType(i)=="dialog"){h=JC.Dialog.confirm(b._model.formResetConfirm(i),2)}else{h=JC.confirm(b._model.formResetConfirm(i),i,2)}h.on("confirm",function(){b.selector().data(d.Model.RESET_CONFIRM_BUTTON,null);b.selector().trigger("reset");b._view.reset();b.trigger("EnableSubmit")});h.on("close",function(){b.selector().data(d.Model.RESET_CONFIRM_BUTTON,null)})})},_inited:function(){JC.log("FormLogic#_inited",new Date().getTime());var b=this,a=b.selector().find("input[type=file][name]");a.length&&b.selector().attr("enctype","multipart/form-data")&&b.selector().attr("encoding","multipart/form-data");b.trigger("BindFrame")}};JC.BaseMVC.buildModel(d);d.Model._instanceName="FormLogicIns";d.Model.GET="get";d.Model.POST="post";d.Model.AJAX="ajax";d.Model.IFRAME="iframe";d.Model.SUBMIT_CONFIRM_BUTTON="SubmitButton";d.Model.RESET_CONFIRM_BUTTON="ResetButton";d.Model.GENERIC_SUBMIT_BUTTON="GenericSubmitButton";d.Model.GENERIC_RESET_BUTTON="GenericResetButton";d.Model.EVT_CONFIRM="ConfirmEvent";d.Model.EVT_RESET="ResetEvent";d.Model.EVT_AJAX_SUBMIT="AjaxSubmit";d.Model.INS_COUNT=1;d.Model.prototype={init:function(){this.id()},id:function(){if(!this._id){this._id="FormLogicIns_"+(d.Model.INS_COUNT++)}return this._id},isSubmited:function(a){typeof a!="undefined"&&(this._submited=a);return this._submited},formType:function(){var a=this.stringProp("method");!a&&(a=d.Model.GET);a=this.stringProp("formType")||a;return a},frame:function(){var a=this;if(!(a._frame&&a._frame.length&&a._frame.parent())){if(a.selector().is("[target]")){a._frame=c(printf("iframe[name={0}]",a.selector().attr("target")))}if(!(a._frame&&a._frame.length)){a.selector().prop("target",a.frameId());a._frame=c(printf(d.frameTpl,a.frameId()));a.selector().after(a._frame)}}return a._frame},frameId:function(){return this.id()+"_iframe"},formSubmitType:function(){var a=this.stringProp("ajaxSubmitType")||this.stringProp("formSubmitType")||d.formSubmitType||"plugins";return a.toLowerCase()},formAjaxResultType:function(){var a=this.stringProp("formAjaxResultType")||"json";return a},formAjaxMethod:function(){var a=this.stringProp("formAjaxMethod")||this.stringProp("method");!a&&(a=d.Model.GET);return a.toLowerCase()},formAjaxAction:function(){var a=this.stringProp("formAjaxAction")||this.stringProp("action")||"?";return urlDetect(a)},formSubmitDisable:function(){var f=this,a=d.submitDisable,b=f.selector().data(d.Model.GENERIC_SUBMIT_BUTTON);f.selector().is("[formSubmitDisable]")&&(a=parseBool(f.selector().attr("formSubmitDisable")));b&&b.is("[formSubmitDisable]")&&(a=parseBool(b.attr("formSubmitDisable")));return a},formResetAfterSubmit:function(){var b=this,a=d.resetAfterSubmit;b.selector().is("[formResetAfterSubmit]")&&(a=parseBool(b.selector().attr("formResetAfterSubmit")));return a},formAjaxDone:function(){var f=this,a=f._innerAjaxDone,b=f.selector().data(d.Model.GENERIC_SUBMIT_BUTTON);a=f.userFormAjaxDone()||a;return a},userFormAjaxDone:function(){var f=this,a,b=f.selector().data(d.Model.GENERIC_SUBMIT_BUTTON);f.selector().is("[formAjaxDone]")&&(a=this.callbackProp("formAjaxDone")||a);b&&(b=c(b)).length&&(a=f.callbackProp(b,"formAjaxDone")||a);return a},_innerAjaxDone:function(k,b,l){var i=c(this),a,j="";k.data&&k.data.returnurl&&(j=k.data.returnurl);k.url&&(j=k.url);if(k.errorno){a=JC.Dialog.alert(k.errmsg||"操作失败, 请重新尝试!",1)}else{a=JC.Dialog.msgbox(k.errmsg||"操作成功",0,function(){l._model.formAjaxDoneAction()&&reloadPage(j||l._model.formAjaxDoneAction())},l._model.formPopupCloseMs())}},formPopupCloseMs:function(b){var f=this,a=d.popupCloseMs,b=b||f.selector().data(d.Model.GENERIC_SUBMIT_BUTTON);f.selector().is("[formPopupCloseMs]")&&(a=this.intProp("formPopupCloseMs")||a);b&&(b=c(b)).length&&(a=f.intProp(b,"formPopupCloseMs")||a);return a},formAjaxDoneAction:function(){var f=this,a="",b=f.selector().data(d.Model.GENERIC_SUBMIT_BUTTON);f.selector().is("[formAjaxDoneAction]")&&(a=this.stringProp("formAjaxDoneAction")||a);b&&(b=c(b)).length&&(a=f.stringProp(b,"formAjaxDoneAction")||a);return urlDetect(a)},formBeforeProcess:function(){return this.callbackProp("formBeforeProcess")},formAfterProcess:function(){return this.callbackProp("formAfterProcess")},formProcessError:function(){return this.callbackProp("formProcessError")},prevent:function(a){a&&a.preventDefault();return false},formConfirmPopupType:function(b){var a=this.stringProp("formConfirmPopupType")||"dialog";b&&(b=c(b)).length&&b.is("[formConfirmPopupType]")&&(a=b.attr("formConfirmPopupType"));return a.toLowerCase()},formResetUrl:function(){var f=this,a=f.stringProp("formResetUrl"),b=f.selector().data(d.Model.GENERIC_RESET_BUTTON);b&&(b=c(b)).length&&(a=f.stringProp(b,"formResetUrl")||a);return urlDetect(a)},formSubmitConfirm:function(b){var a=this.stringProp("formSubmitConfirm");b&&(b=c(b)).length&&b.is("[formSubmitConfirm]")&&(a=this.stringProp(b,"formSubmitConfirm"));!a&&(a="确定要提交吗?");return a.trim()},formResetConfirm:function(b){var a=this.stringProp("formResetConfirm");b&&(b=c(b)).length&&b.is("[formResetConfirm]")&&(a=this.stringProp(b,"formResetConfirm"));!a&&(a="确定要重置吗?");return a.trim()}};JC.BaseMVC.buildView(d);d.View.prototype={initQueryVal:function(){var a=this;if(a._model.formType()!=d.Model.GET){return}JC.Form&&JC.Form.initAutoFill(a._model.selector())},reset:function(a){var f=this,b=f._model.formResetUrl();b&&reloadPage(b);f._model.resetTimeout&&clearTimeout(f._model.resetTimeout);f._model.resetTimeout=setTimeout(function(){var e=f._model.selector();e.find("input[type=text], input[type=password], input[type=file], textarea").val("");e.find("select").each(function(){var j=c(this);var l=j.find("option");if(l.length>1){j.val(c(l[0]).val())}var k=j.is("[ignoreprocess]");j.attr("ignoreprocess",true);j.trigger("change");setTimeout(function(){!k&&j.removeAttr("ignoreprocess")},500)});JC.Valid&&JC.Valid.clearError(e)},50);JC.hideAllPopup(1)}};JC.BaseMVC.build(d,"Bizs");c(document).delegate("input[formSubmitConfirm], button[formSubmitConfirm]","click",function(h){var i=c(this),j=getJqParent(i,"form"),b=d.getInstance(j),a;if(j&&j.length){if(b){if(i.is("[formConfirmCheckSelector]")){a=parentSelector(i,i.attr("formConfirmCheckSelector"));if(!(a&&a.length)){return}}else{if(i.is("[formConfirmCheckCallback]")){a=window[i.attr("formConfirmCheckCallback")];if(a){if(!a.call(j,i,h,b)){return}}}}}j.data(d.Model.SUBMIT_CONFIRM_BUTTON,i)}});c(document).delegate("input[formResetConfirm], button[formResetConfirm]","click",function(a){var b=c(this),f=getJqParent(b,"form");f&&f.length&&f.data(d.Model.RESET_CONFIRM_BUTTON,b)});c(document).delegate("input[type=reset], button[type=reset]","click",function(a){var b=c(this),f=getJqParent(b,"form");f&&f.length&&f.data(d.Model.GENERIC_RESET_BUTTON,b)});c(document).delegate("input[type=submit], button[type=submit]","click",function(a){var b=c(this),f=getJqParent(b,"form");f&&f.length&&f.data(d.Model.GENERIC_SUBMIT_BUTTON,b)});c(document).delegate("a[buttonReturnUrl], input[buttonReturnUrl], button[buttonReturnUrl]","click",function(l){var m=c(this),k=m.attr("buttonReturnUrl").trim(),a=m.is("[returnConfirm]")?m.attr("returnConfirm"):"",n=m.is("[popuptype]")?m.attr("popuptype"):"confirm",b=parseInt(m.is("[popupstatus]")?m.attr("popupstatus"):"2",10),j;if(!k){return}k=urlDetect(k);m.prop("nodeName").toLowerCase()=="a"&&l.preventDefault();if(a){switch(n){case"dialog.confirm":j=JC.Dialog.confirm(a,b);break;default:j=JC.confirm(a,m,b);break}j.on("confirm",function(){reloadPage(k)})}else{reloadPage(k)}});d.frameTpl='<iframe src="about:blank" id="{0}" name="{0}" frameborder="0" class="BFLIframe" style="display:none;"></iframe>';c(document).ready(function(){setTimeout(function(){d.autoInit&&d.init(c(document))},1)})}(jQuery));