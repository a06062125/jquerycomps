(function(b){Bizs.FormLogic=a;function a(c){c&&(c=b(c));if(a.getInstance(c)){return a.getInstance(c)}a.getInstance(c,this);this._model=new a.Model(c);this._view=new a.View(this._model);this._init()}a.getInstance=function(c,d){if(typeof c=="string"&&!/</.test(c)){c=b(c)}if(!(c&&c.length)||(typeof c=="string")){return}typeof d!="undefined"&&c.data("FormLogicIns",d);return c.data("FormLogicIns")};!JC.Valid&&JC.use("Valid");!JC.Form&&JC.use("Form");!JC.Panel&&JC.use("Panel");!b(document).ajaxForm&&JC.use("plugins.jquery.form");a.init=function(c){var d=[];c&&(c=b(c));if(!(c&&c.length)){return}if(c.prop("nodeName").toLowerCase()=="form"){d.push(new a(c))}else{c.find("form.js_bizsFormLogic, form.js_autoFormLogic").each(function(){d.push(new a(this))})}return d};a.popupCloseMs=2000;a.formSubmitType="";a.submitDisable=true;a.resetAfterSubmit=true;a.prototype={_beforeInit:function(){},_initHanlderEvent:function(){var c=this,d=c._model.formType();c._view.initQueryVal();c.on(a.Model.EVT_AJAX_SUBMIT,function(){var e=c._model.formAjaxMethod();JC.log(a.Model.EVT_AJAX_SUBMIT,e);var f=c._model.selector().serialize();b[e]&&b[e](c._model.formAjaxAction(),f).done(function(g){JC.log("common ajax done");c.trigger("AjaxDone",[g])})});c.on("AjaxDone",function(f,h){c._model.formResetAfterSubmit()&&!c._model.userFormAjaxDone()&&c.selector().trigger("reset");c._model.formSubmitDisable()&&c.trigger("EnableSubmit");var e;try{e=b.parseJSON(h)}catch(g){}e&&"errorno" in e&&!parseInt(e.errorno,10)&&c._model.formResetAfterSubmit()&&c.selector().trigger("reset");e=e||h||{};c._model.formAjaxDone()&&c._model.formAjaxDone().call(c._model.selector(),e,c._model.selector().data(a.Model.GENERIC_SUBMIT_BUTTON),c)});c.on("ProcessDone",function(){c._model.formSubmitDisable()&&c.selector().find("input[type=submit], button[type=submit]").each(function(){b(this).prop("disabled",true)})});if(c._model.formType()=="ajax"&&c._model.formSubmitType()=="plugins"){c.selector().ajaxForm({beforeSubmit:function(){if(c._model.formBeforeProcess()){if(c._model.formBeforeProcess().call(c.selector(),null,c)===false){return c._model.prevent()}}if(!JC.Valid.check(c.selector())){c._model.formProcessError()&&c._model.formProcessError().call(c.selector(),null,c);return c._model.prevent()}if(c._model.formAfterProcess()){if(c._model.formAfterProcess().call(c.selector(),null,c)===false){return c._model.prevent()}}if(c.selector().data(a.Model.SUBMIT_CONFIRM_BUTTON)){c.trigger(a.Model.EVT_CONFIRM);return c._model.prevent()}c.trigger("ProcessDone")},success:function(e){JC.log("plugins ajax done");c.trigger("AjaxDone",[e])}})}else{c.selector().on("submit",function(e){if(c._model.formBeforeProcess()){if(c._model.formBeforeProcess().call(c.selector(),e,c)===false){return c._model.prevent(e)}}if(!JC.Valid.check(c.selector())){return c._model.prevent(e)}if(c._model.formAfterProcess()){if(c._model.formAfterProcess().call(c.selector(),e,c)===false){return c._model.prevent(e)}}if(c.selector().data(a.Model.SUBMIT_CONFIRM_BUTTON)){c.trigger(a.Model.EVT_CONFIRM);return c._model.prevent(e)}c.trigger("ProcessDone");if(d==a.Model.AJAX){c.trigger(a.Model.EVT_AJAX_SUBMIT);return c._model.prevent(e)}})}c.on(a.Model.EVT_CONFIRM,function(e){var f=c.selector().data(a.Model.SUBMIT_CONFIRM_BUTTON);f&&(f=b(f));if(!(f&&f.length)){return}var g;if(c._model.formConfirmPopupType(f)=="dialog"){g=JC.Dialog.confirm(c._model.formSubmitConfirm(f),2)}else{g=JC.confirm(c._model.formSubmitConfirm(f),f,2)}g.on("confirm",function(){c.selector().data(a.Model.SUBMIT_CONFIRM_BUTTON,null);c.selector().trigger("submit")});g.on("close",function(){c.selector().data(a.Model.SUBMIT_CONFIRM_BUTTON,null)})});c.selector().on("reset",function(e){if(c.selector().data(a.Model.RESET_CONFIRM_BUTTON)){c.trigger(a.Model.EVT_RESET);return c._model.prevent(e)}else{c._view.reset();c.trigger("EnableSubmit")}});c.on("EnableSubmit",function(){c.selector().find("input[type=submit], button[type=submit]").each(function(){b(this).prop("disabled",false)})});c.on(a.Model.EVT_RESET,function(e){var f=c.selector().data(a.Model.RESET_CONFIRM_BUTTON);f&&(f=b(f));if(!(f&&f.length)){return}var g;if(c._model.formConfirmPopupType(f)=="dialog"){g=JC.Dialog.confirm(c._model.formResetConfirm(f),2)}else{g=JC.confirm(c._model.formResetConfirm(f),f,2)}g.on("confirm",function(){c.selector().data(a.Model.RESET_CONFIRM_BUTTON,null);c.selector().trigger("reset");c._view.reset();c.trigger("EnableSubmit")});g.on("close",function(){c.selector().data(a.Model.RESET_CONFIRM_BUTTON,null)})})}};JC.BaseMVC.buildModel(a);a.Model._instanceName="FormLogicIns";a.Model.GET="get";a.Model.POST="post";a.Model.AJAX="ajax";a.Model.IFRAME="iframe";a.Model.SUBMIT_CONFIRM_BUTTON="SubmitButton";a.Model.RESET_CONFIRM_BUTTON="ResetButton";a.Model.GENERIC_SUBMIT_BUTTON="GenericSubmitButton";a.Model.GENERIC_RESET_BUTTON="GenericResetButton";a.Model.EVT_CONFIRM="ConfirmEvent";a.Model.EVT_RESET="ResetEvent";a.Model.EVT_AJAX_SUBMIT="AjaxSubmit";a.Model.prototype={init:function(){},formType:function(){var c=this.stringProp("method");!c&&(c=a.Model.GET);c=this.stringProp("formType")||c;return c.toLowerCase()},formSubmitType:function(){var c=this.stringProp("ajaxSubmitType")||this.stringProp("formSubmitType")||a.formSubmitType||"plugins";return c.toLowerCase()},formAjaxMethod:function(){var c=this.stringProp("formAjaxMethod")||this.stringProp("method");!c&&(c=a.Model.GET);return c.toLowerCase()},formAjaxAction:function(){var c=this.stringProp("formAjaxAction")||this.stringProp("action")||"?";return urlDetect(c)},formSubmitDisable:function(){var c=this,e=a.submitDisable,d=c.selector().data(a.Model.GENERIC_SUBMIT_BUTTON);c.selector().is("[formSubmitDisable]")&&(e=parseBool(c.selector().attr("formSubmitDisable")));d&&d.is("[formSubmitDisable]")&&(e=parseBool(d.attr("formSubmitDisable")));return e},formResetAfterSubmit:function(){var c=this,d=a.resetAfterSubmit;c.selector().is("[formResetAfterSubmit]")&&(d=parseBool(c.selector().attr("formResetAfterSubmit")));return d},formAjaxDone:function(){var c=this,e=c._innerAjaxDone,d=c.selector().data(a.Model.GENERIC_SUBMIT_BUTTON);e=c.userFormAjaxDone()||e;return e},userFormAjaxDone:function(){var c=this,e,d=c.selector().data(a.Model.GENERIC_SUBMIT_BUTTON);c.selector().is("[formAjaxDone]")&&(e=this.callbackProp("formAjaxDone")||e);d&&(d=b(d)).length&&(e=c.callbackProp(d,"formAjaxDone")||e);return e},_innerAjaxDone:function(d,f,c){var e=b(this),g;if(d.errorno){g=JC.Dialog.alert(d.errmsg||"操作失败, 请重新尝试!",1)}else{g=JC.Dialog.msgbox(d.errmsg||"操作成功",0,function(){c._model.formAjaxDoneAction()&&reloadPage(c._model.formAjaxDoneAction())},c._model.formPopupCloseMs())}},formPopupCloseMs:function(d){var c=this,e=a.popupCloseMs,d=d||c.selector().data(a.Model.GENERIC_SUBMIT_BUTTON);c.selector().is("[formPopupCloseMs]")&&(e=this.intProp("formPopupCloseMs")||e);d&&(d=b(d)).length&&(e=c.intProp(d,"formPopupCloseMs")||e);return e},formAjaxDoneAction:function(){var c=this,e="",d=c.selector().data(a.Model.GENERIC_SUBMIT_BUTTON);c.selector().is("[formAjaxDoneAction]")&&(e=this.stringProp("formAjaxDoneAction")||e);d&&(d=b(d)).length&&(e=c.stringProp(d,"formAjaxDoneAction")||e);return urlDetect(e)},formBeforeProcess:function(){return this.callbackProp("formBeforeProcess")},formAfterProcess:function(){return this.callbackProp("formAfterProcess")},formProcessError:function(){return this.callbackProp("formProcessError")},prevent:function(c){c&&c.preventDefault();return false},formConfirmPopupType:function(c){var d=this.stringProp("formConfirmPopupType")||"dialog";c&&(c=b(c)).length&&c.is("[formConfirmPopupType]")&&(d=c.attr("formConfirmPopupType"));return d.toLowerCase()},formResetUrl:function(){var c=this,e=c.stringProp("formResetUrl"),d=c.selector().data(a.Model.GENERIC_RESET_BUTTON);d&&(d=b(d)).length&&(e=c.stringProp(d,"formResetUrl")||e);return urlDetect(e)},formSubmitConfirm:function(c){var d=this.stringProp("formSubmitConfirm");c&&(c=b(c)).length&&c.is("[formSubmitConfirm]")&&(d=this.stringProp(c,"formSubmitConfirm"));!d&&(d="确定要提交吗?");return d.trim()},formResetConfirm:function(c){var d=this.stringProp("formResetConfirm");c&&(c=b(c)).length&&c.is("[formResetConfirm]")&&(d=this.stringProp(c,"formResetConfirm"));!d&&(d="确定要重置吗?");return d.trim()}};JC.BaseMVC.buildView(a);a.View.prototype={initQueryVal:function(){var c=this;if(c._model.formType()!=a.Model.GET){return}JC.Form&&JC.Form.initAutoFill(c._model.selector())},reset:function(e){var c=this,d=c._model.formResetUrl();d&&reloadPage(d);c._model.resetTimeout&&clearTimeout(c._model.resetTimeout);c._model.resetTimeout=setTimeout(function(){var f=c._model.selector();f.find("input[type=text], input[type=password], input[type=file], textarea").val("");f.find("select").each(function(){var i=b(this);var g=i.find("option");if(g.length>1){i.val(b(g[0]).val())}var h=i.is("[ignoreprocess]");i.attr("ignoreprocess",true);i.trigger("change");setTimeout(function(){!h&&i.removeAttr("ignoreprocess")},500)});JC.Valid&&JC.Valid.clearError(f)},50);JC.hideAllPopup(1)}};JC.BaseMVC.build(a,"Bizs");b(document).delegate("input[formSubmitConfirm], button[formSubmitConfirm]","click",function(e){var d=b(this),c=getJqParent(d,"form");c&&c.length&&c.data(a.Model.SUBMIT_CONFIRM_BUTTON,d)});b(document).delegate("input[formResetConfirm], button[formResetConfirm]","click",function(e){var d=b(this),c=getJqParent(d,"form");c&&c.length&&c.data(a.Model.RESET_CONFIRM_BUTTON,d)});b(document).delegate("input[type=reset], button[type=reset]","click",function(e){var d=b(this),c=getJqParent(d,"form");c&&c.length&&c.data(a.Model.GENERIC_RESET_BUTTON,d)});b(document).delegate("input[type=submit], button[type=submit]","click",function(e){var d=b(this),c=getJqParent(d,"form");c&&c.length&&c.data(a.Model.GENERIC_SUBMIT_BUTTON,d)});b(document).delegate("a[buttonReturnUrl], input[buttonReturnUrl], button[buttonReturnUrl]","click",function(e){var d=b(this),f=d.attr("buttonReturnUrl").trim(),i=d.is("[returnConfirm]")?d.attr("returnConfirm"):"",c=d.is("[popuptype]")?d.attr("popuptype"):"confirm",h=parseInt(d.is("[popupstatus]")?d.attr("popupstatus"):"2",10),g;if(!f){return}f=urlDetect(f);d.prop("nodeName").toLowerCase()=="a"&&e.preventDefault();if(i){switch(c){case"dialog.confirm":g=JC.Dialog.confirm(i,h);break;default:g=JC.confirm(i,d,h);break}g.on("confirm",function(){reloadPage(f)})}else{reloadPage(f)}});b(document).ready(function(){setTimeout(function(){a.autoInit&&a.init(b(document))},1)})}(jQuery));