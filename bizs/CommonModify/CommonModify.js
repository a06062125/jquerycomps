(function(e){window.Bizs.CommonModify=f;function f(a){a&&(a=e(a));if(f._instance){return f._instance}if(!f._instance){f._instance=this}this._model=new g(a);this._view=new h(this._model);this._init();a&&a.length&&this.process(a)}f.prototype={_init:function(){var a=this;a._initHandlerEvent();e([a._view,a._model]).on("BindEvent",function(d,b,c){a.on(b,c)});e([a._view,a._model]).on("TriggerEvent",function(d,b){var c=sliceArgs(arguments);c.shift();c.shift();a.trigger(b,c)});a._model.init();a._view.init();return a},_initHandlerEvent:function(){var a=this;a.on("add",function(c,d,b){a._model.cmaddcallback()&&a._model.cmaddcallback().call(a.selector(),a,d,a._model.cmitem(),b)});a.on("del",function(c,d,b){a._model.cmdelcallback()&&a._model.cmdelcallback().call(a.selector(),a,b)});a.on("done",function(c,d,b){a._model.cmdonecallback()&&a._model.cmdonecallback().call(a.selector(),a,b)})},selector:function(){return this._model.selector()},on:function(a,b){e(this).on(a,b);return this},trigger:function(a,b){e(this).trigger(a,b);return this},process:function(a){if(!(a&&(a=e(a)).length)){return this}this._model.selector(a);switch(this._model.action()){case"del":this._view.del();break;default:this._view.add();break}},cmitem:function(){return this._model.cmitem()}};f.getInstance=function(){!f._instance&&(f._instance=new f());return f._instance};f._instance=null;f.isCommonModify=function(b){var a;b&&(b=e(b)).length&&(a=b.is("[CommonModifylayout]"));return a};f.doneCallback=null;f.tplFilterCallback=null;f.beforeAddCallback=null;f.addCallback=null;f.beforeDelCallabck=null;f.delCallback=null;function g(a){this._selector=a}g.prototype={init:function(){return this},selector:function(a){a&&(a=e(a))&&(this._selector=a);return this._selector},layout:function(){},action:function(){var a="add",b;(b=this.selector().attr("cmaction"))&&(a=b.toLowerCase());return a},cmtemplate:function(){var a="",b;this.selector()&&(b=this.selector().attr("cmtemplate")||this.selector().attr("cmtpl"))&&(a=scriptContent(b));return a},cmdonecallback:function(){var a=f.doneCallback,b;this.selector()&&(b=this.selector().attr("cmdonecallback"))&&(b=window[b])&&(a=b);return a},cmtplfiltercallback:function(){var a=f.tplFilterCallback,b;this.selector()&&(b=this.selector().attr("cmtplfiltercallback"))&&(b=window[b])&&(a=b);return a},cmaddcallback:function(){var a=f.addCallback,b;this.selector()&&(b=this.selector().attr("cmaddcallback"))&&(b=window[b])&&(a=b);return a},cmdelcallback:function(){var a=f.delCallback,b;this.selector()&&(b=this.selector().attr("cmdelcallback"))&&(b=window[b])&&(a=b);return a},cmbeforeaddcallabck:function(){var a=f.beforeAddCallback,b;this.selector()&&(b=this.selector().attr("cmbeforeaddcallabck"))&&(b=window[b])&&(a=b);return a},cmbeforedelcallback:function(){var a=f.beforeDelCallabck,b;this.selector()&&(b=this.selector().attr("cmbeforedelcallback"))&&(b=window[b])&&(a=b);return a},cmitem:function(){var a,b;this.selector()&&(b=this.selector().attr("cmitem"))&&(a=parentSelector(this.selector(),b));return a},cmappendtype:function(){var a=this.selector().attr("cmappendtype")||"after";return a}};function h(a){this._model=a}h.prototype={init:function(){return this},add:function(){JC.log("Bizs.CommonModify view add",new Date().getTime());var j=this,a=j._model.cmtemplate(),b=j._model.cmitem(),c=b.parent(),d;if(j._model.cmbeforeaddcallabck()&&j._model.cmbeforeaddcallabck().call(j._model.selector(),b,c)===false){return}j._model.cmtplfiltercallback()&&(a=j._model.cmtplfiltercallback().call(j._model.selector(),a,b,c));a=a.replace(/<([\d]+)>/g,"{$1}");JC.log("_item:",b,b.length);if(!(a&&b&&b.length)){return}d=e(a);switch(j._model.cmappendtype()){case"appendTo":d.appendTo(b);break;case"before":b.before(d);break;default:b.after(d);break}window.jcAutoInitComps&&jcAutoInitComps(d);e(j).trigger("TriggerEvent",["add",d,c]);e(j).trigger("TriggerEvent",["done",d,c])},del:function(){JC.log("Bizs.CommonModify view del",new Date().getTime());var c=this,a=c._model.cmitem(),b=a.parent();if(c._model.cmbeforedelcallback()&&c._model.cmbeforedelcallback().call(c._model.selector(),a,b)===false){return}a&&a.length&&a.remove();e(c).trigger("TriggerEvent",["del",a,b]);e(c).trigger("TriggerEvent",["done",a,b])}};e(document).delegate("a.js_autoCommonModify, button.js_autoCommonModify, a.js_bizsCommonModify, button.js_bizsCommonModify","click",function(a){f.getInstance().process(e(this))})}(jQuery));