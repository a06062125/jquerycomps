(function(c){window.Bizs.ActionLogic=d;function d(a){a&&(a=c(a));if(d.getInstance(a)){return d.getInstance(a)}d.getInstance(a,this);this._model=new d.Model(a);this._view=new d.View(this._model);this._init()}!JC.Panel&&JC.use("Panel");d.getInstance=function(b,a){if(typeof b=="string"&&!/</.test(b)){b=c(b)}if(!(b&&b.length)||(typeof b=="string")){return}typeof a!="undefined"&&b.data("ActionLogicIns",a);return b.data("ActionLogicIns")};d.isActionLogic=function(b){var a;b&&(b=c(b)).length&&(a=b.is("[baltype]"));return a};d.init=function(a){a&&c(a).find(["a.js_bizsActionLogic","input.js_bizsActionLogic","button.js_bizsActionLogic"].join()).on("click",function(b){var f=c(this);d.process(f)&&(f.prop("nodeName").toLowerCase()=="a"&&b.preventDefault())})};d.process=function(b){b=c(b);if(!(b&&b.length)){return null}if(!d.isActionLogic(b)){return}var a=d.getInstance(b);!a&&(a=new d(b));a&&a.process();return a};d.random=true;d.prototype={_beforeInit:function(){},_initHanlderEvent:function(){var a=this;a.on("StaticPanel",function(f,b){a.trigger("ShowPanel",[scriptContent(b)])});a.on(d.Model.SHOW_PANEL,function(g,h){var b=JC.Dialog(h);b.on("confirm",function(){if(a._model.balCallback()&&a._model.balCallback().call(a._model.selector(),b,a)){return true}return false})});a.on("AjaxPanel",function(h,g,b){if(!(g&&b)){return}a._model.balRandom()&&(b=addUrlParams(b,{rnd:new Date().getTime()}));c.get(b).done(function(f){switch(g){case d.Model.SHOW_PANEL:a.trigger("ShowPanel",[f]);break;case d.Model.DATA_PANEL:try{f=c.parseJSON(f)}catch(e){}if(f){if(f.errorno){a.trigger("ShowError",[f.errmsg||"操作失败, 请重试!",1])}else{a.trigger("ShowPanel",[f.data])}}break}})});a.on("Go",function(f,b){if(!b){return}a._model.balRandom()&&(b=addUrlParams(b,{rnd:new Date().getTime()}));reloadPage(b)});a.on("AjaxAction",function(f,b){if(!b){return}a._model.balRandom()&&(b=addUrlParams(b,{rnd:new Date().getTime()}));c.get(b).done(function(h){try{h=c.parseJSON(h)}catch(e){}if(a._model.balCallback()){a._model.balCallback().call(a.selector(),h,a)}else{if(h&&"errorno" in h){if(h.errorno){a.trigger("ShowError",[h.errmsg||"操作失败, 请重试!",1])}else{a.trigger("ShowSuccess",[h.errmsg||"操作完成",function(){a._model.balDoneUrl()&&reloadPage(a._model.balDoneUrl()||location.href)}])}}else{JC.Dialog.alert(h,1)}}})});a.on("ShowError",function(l,b,j,k){var i;switch(a._model.balErrorPopupType()){case"alert":i=JC.alert(b,a._model.selector(),j||1);k&&i.on("confirm",function(){k()});break;case"msgbox":i=JC.msgbox(b,a._model.selector(),j||1);k&&i.on("close",function(){k()});break;case"dialog.msgbox":i=JC.Dialog.msgbox(b,j||1);k&&i.on("close",function(){k()});break;default:i=JC.Dialog.alert(b,j||1);k&&i.on("confirm",function(){k()});break}});a.on("ShowConfirm",function(l,b,j,k){var i;switch(a._model.balConfirmPopupType()){case"dialog.confirm":i=JC.Dialog.confirm(b,j||1);k&&i.on("confirm",function(){k()});break;default:i=JC.confirm(b,a._model.selector(),j||1);k&&i.on("confirm",function(){k()});break}});a.on("ShowSuccess",function(j,b,i){var h;switch(a._model.balSuccessPopupType()){case"alert":h=JC.alert(b,a._model.selector());i&&h.on("confirm",function(){i()});break;case"dialog.alert":h=JC.Dialog.alert(b);i&&h.on("confirm",function(){i()});break;case"dialog.msgbox":h=JC.Dialog.msgbox(b);i&&h.on("close",function(){i()});break;default:h=JC.msgbox(b,a.selector());i&&h.on("close",function(){i()});break}})},process:function(){var b=this;JC.hideAllPopup(1);switch(b._model.baltype()){case"panel":if(b._model.is("[balPanelTpl]")){b.trigger("StaticPanel",[b._model.balPanelTpl()])}else{if(b._model.is("[balAjaxHtml]")){b.trigger("AjaxPanel",[d.Model.SHOW_PANEL,b._model.balAjaxHtml()])}else{if(b._model.is("[balAjaxData]")){b.trigger("AjaxPanel",[d.Model.DATA_PANEL,b._model.balAjaxData()])}}}break;case"link":if(b._model.is("[balConfirmMsg]")){b.trigger("ShowConfirm",[b._model.balConfirmMsg(),2,function(){b.trigger("Go",b._model.balUrl())}])}else{b.trigger("Go",b._model.balUrl())}break;case"ajaxaction":if(b._model.is("[balConfirmMsg]")){var a=JC.confirm(b._model.balConfirmMsg(),b.selector(),2);a.on("confirm",function(){b.trigger("AjaxAction",b._model.balUrl())})}else{b.trigger("AjaxAction",b._model.balUrl())}break}return this}};JC.BaseMVC.buildModel(d);d.Model.SHOW_PANEL="ShowPanel";d.Model.DATA_PANEL="DataPanel";d.Model.prototype={init:function(){},baltype:function(){return this.stringProp("baltype")},balPanelTpl:function(){var a,b=this;a=b.selectorProp("balPanelTpl")||a;return a},balCallback:function(){var a,b=this;a=b.callbackProp("balCallback")||a;return a},balAjaxHtml:function(){return this.selector().attr("balAjaxHtml")},balAjaxData:function(){return this.selector().attr("balAjaxData")},balRandom:function(){var a=d.random,b=this;b.is("[balRandom]")&&(a=parseBool(b.stringProp("balRandom")));return a},balUrl:function(){var a="?",b=this;b.selector().prop("nodeName").toLowerCase()=="a"&&(a=b.selector().attr("href"));b.is("[balUrl]")&&(a=b.selector().attr("balUrl"));return urlDetect(a)},balDoneUrl:function(){var a=this.stringProp("balDoneUrl");return urlDetect(a)},balConfirmMsg:function(){var a="确定要执行吗?";a=this.selector().attr("balConfirmMsg")||a;return a},balErrorPopupType:function(){var a=this.stringProp("balErrorPopupType")||"dialog";return a},balSuccessPopupType:function(){var a=this.stringProp("balSuccessPopupType")||"msgbox";return a},balConfirmPopupType:function(){var a=this.stringProp("balConfirmPopupType")||"confirm";return a}};JC.BaseMVC.buildView(d);d.View.prototype={init:function(){}};JC.BaseMVC.build(d);c(document).ready(function(){c(document).delegate(["a.js_bizsActionLogic","input.js_bizsActionLogic","button.js_bizsActionLogic"].join(),"click",function(a){var b=c(this);d.process(b)&&(b.prop("nodeName").toLowerCase()=="a"&&a.preventDefault())})})}(jQuery));