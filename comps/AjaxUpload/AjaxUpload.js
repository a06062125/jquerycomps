(function(a){JC.AjaxUpload=b;function b(c){if(b.getInstance(c)){return b.getInstance(c)}if(!c.hasClass("js_compAjaxUpload")){return b.init(c)}b.getInstance(c,this);this._model=new b.Model(c);this._view=new b.View(this._model);JC.log("AjaxUpload init",new Date().getTime());this._init()}b.getInstance=function(c,d){if(typeof c=="string"&&!/</.test(c)){c=a(c)}if(!(c&&c.length)||(typeof c=="string")){return}typeof d!="undefined"&&c.data(b.Model._instanceName,d);return c.data(b.Model._instanceName)};b.init=function(c){var d=[];c=a(c||document);if(c.hasClass("js_compAjaxUpload")){d.push(new b(c))}else{c.find("input.js_compAjaxUpload, button.js_compAjaxUpload").each(function(){d.push(new b(a(this)))})}return d};b.frameFileName="default.html";b.randomFrame=false;b._FRAME_DIR="comps/AjaxUpload/frame/";b._INS_COUNT=1;b.prototype={_beforeInit:function(){var c=this;JC.log("AjaxUpload _beforeInit",new Date().getTime())},_initHanlderEvent:function(){var c=this;c.on("FrameLoad",function(d){var e=c._model.frame().prop("contentWindow");if(!(e&&e.initPage)){return}e.initPage(c,c._model);if(c._model.INITED){return}c._model.INITED=true;if(c._model.cauDefaultHide()){setTimeout(function(){c._model.frame().hide();c._model.selector().hide()},1)}});c.on("ERR_FILE_EXT",function(d,e){c._view.errFileExt(e);c._view.updateChange()});c.on("BeforeUpload",function(d){c._view.beforeUpload()});c.on("UploadDone",function(e,d){JC.log(d);var h=false,g=d;try{typeof d=="string"&&(d=a.parseJSON(d))}catch(f){d={};h=true}if(h){c._view.errFatalError(g);c._view.updateChange();c._model.cauUploadErrorCallback()&&c._model.cauUploadErrorCallback().call(c,d,c._model.selector(),c._model.frame())}else{if(d.errorno){c._view.errUpload(d);c._view.updateChange()}else{c._view.updateChange(d)}c._model.cauUploadDoneCallback()&&c._model.cauUploadDoneCallback().call(c,d,c._model.selector(),c._model.frame())}});c.on("AUUpdateLayout",function(e,d,f,g){c._view.updateLayout(d,f,g)})},_inited:function(){var c=this;JC.log("AjaxUpload _inited",new Date().getTime());c._view.loadFrame();b.getInstance(c._model.frame(),c);c.trigger("AUInited")},update:function(d){var c=this;a(c._view).trigger("UpdateDefaultStatus");d&&c.trigger("UploadDone",[d]);return this}};BaseMVC.buildModel(b);b.Model._instanceName="AjaxUpload";b.Model.prototype={init:function(){JC.log("AjaxUpload.Model.init:",new Date().getTime())},cauStyle:function(){return this.attrProp("cauStyle")},cauButtonText:function(){return this.attrProp("cauButtonText")},cauUrl:function(){return this.attrProp("cauUrl")},cauFileExt:function(){return this.stringProp("cauFileExt")},cauFileName:function(){return this.attrProp("cauFileName")},cauLabelKey:function(){return this.attrProp("cauLabelKey")||"name"},cauValueKey:function(){return this.attrProp("cauValueKey")||"url"},cauStatusLabel:function(){return this.selectorProp("cauStatusLabel")},cauDisplayLabel:function(){return this.selectorProp("cauDisplayLabel")},cauDisplayLabelCallback:function(){return this.callbackProp("cauDisplayLabelCallback")},cauDefaultHide:function(){return this.boolProp("cauDefaultHide")},cauUploadDoneCallback:function(){return this.callbackProp("cauUploadDoneCallback")},cauUploadErrorCallback:function(){return this.callbackProp("cauUploadErrorCallback")},cauValue:function(e){var c=this,d=c.cauDisplayLabel(),g="";if(typeof e!="undefined"){var f=e.data[c.cauValueKey()];g=e.data[c.cauLabelKey()];c.selector().val(f)}if(c.cauDisplayLabelCallback()){g=c.cauDisplayLabelCallback().call(c.selector(),e,g,f)}else{g=printf('<a href="{0}" class="green js_auLink" target="_blank">{1}</a>',f,g)}d&&d.length&&d.html(g);return c.selector().val()},framePath:function(){var c=this.attrProp("cauFrameFileName")||b.frameFileName,d=printf("{0}{1}{2}",JC.PATH,b._FRAME_DIR,c);this.randomFrame()&&(d=addUrlParams(d,{rnd:new Date().getTime()}));return d},randomFrame:function(){var c=b.randomFrame;this.selector().is("[cauRandomFrame]")&&(c=this.boolProp("cauRandomFrame"));return c},frame:function(){if(!this._iframe){var c=b.frameTpl;if(this.selector().is("[cauFrameScriptTpl]")){c=scriptContent(parentSelector(this.selector(),this.selector().attr("cauFrameScriptTpl")))}this._iframe=a(b.frameTpl)}return this._iframe}};BaseMVC.buildView(b);b.View.prototype={init:function(){JC.log("AjaxUpload.View.init:",new Date().getTime());var c=this;a(c).on("UpdateDefaultStatus",function(e){var f=c._model.cauStatusLabel(),d=c._model.cauDisplayLabel();c.updateChange();c._model.frame().show();f&&f.length&&f.hide();d&&d.length&&d.hide();(c._model.selector().attr("type")||"").toLowerCase()!="hidden"&&c._model.selector().show()})},loadFrame:function(){var c=this,e=c._model.framePath(),d=c._model.frame();JC.log(e);d.attr("src",e);d.on("load",function(){a(c).trigger("TriggerEvent","FrameLoad")});c._model.selector().before(d)},beforeUpload:function(){var c=this,d=c._model.cauStatusLabel();JC.log("AjaxUpload view#beforeUpload",new Date().getTime());this.updateChange(null,true);if(d&&d.length){c._model.selector().hide();c._model.frame().hide();d.show()}},updateChange:function(e,f){var c=this,g=c._model.cauStatusLabel(),d=c._model.cauDisplayLabel();if(g&&g.length&&!f){c._model.selector().show();c._model.frame().show();g.hide()}if(d&&d.length){d.html("")}c._model.selector().val("");if(e&&("errorno" in e)&&!e.errorno){c._model.cauValue(e);c._model.selector().val()&&c._model.selector().is(":visible")&&c._model.selector().prop("type").toLowerCase()=="text"&&c._model.selector().trigger("blur");if(d&&d.length){c._model.selector().hide();c._model.frame().hide();d.show();return}}},updateLayout:function(d,e,f){if(!(d&&e)){return}var c=this;JC.log("AjaxUpload @event UpdateLayout",new Date().getTime(),d,e);c._model.frame().css({width:d+"px",height:e+"px"})},errUpload:function(d){var c=this,e=c._model.callbackProp("cauUploadErrCallback");if(e){e.call(c._model.selector(),d,c._model.frame())}else{var f=d&&d.errmsg?d.errmsg:"上传失败, 请重试!";JC.Dialog?JC.Dialog.alert(f,1):alert(f)}},errFileExt:function(e){var c=this,d=c._model.callbackProp("cauFileExtErrCallback");if(d){d.call(c._model.selector(),c._model.cauFileExt(),e,c._model.frame())}else{var f=printf('类型错误, 允许上传的文件类型: {0} <p class="auExtErr" style="color:red">{1}</p>',c._model.cauFileExt(),e);JC.Dialog?JC.Dialog.alert(f,1):alert(f)}},errFatalError:function(d){var c=this,e=c._model.callbackProp("cauFatalErrorCallback");if(e){e.call(c._model.selector(),d,c._model.frame())}else{var f=printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',d);JC.Dialog?JC.Dialog.alert(f,1):alert(f)}}};BaseMVC.build(b);b.frameTpl=printf('<iframe src="about:blank" frameborder="0" class="AUIframe" style="{0}"></iframe>',"width: 84px; height: 24px;cursor: pointer; vertical-align: middle;");a(document).ready(function(){b.autoInit&&b.init()})}(jQuery));