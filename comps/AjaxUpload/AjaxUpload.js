(function(d){JC.AjaxUpload=c;function c(a){if(c.getInstance(a)){return c.getInstance(a)}if(!a.hasClass("js_compAjaxUpload")){return c.init(a)}c.getInstance(a,this);this._model=new c.Model(a);this._view=new c.View(this._model);JC.log("AjaxUpload init",new Date().getTime());this._init()}c.getInstance=function(b,a){if(typeof b=="string"&&!/</.test(b)){b=d(b)}if(!(b&&b.length)||(typeof b=="string")){return}typeof a!="undefined"&&b.data(c.Model._instanceName,a);return b.data(c.Model._instanceName)};c.init=function(b){var a=[];b=d(b||document);if(b.hasClass("js_compAjaxUpload")){a.push(new c(b))}else{b.find("input.js_compAjaxUpload, button.js_compAjaxUpload").each(function(){a.push(new c(d(this)))})}return a};c.frameFileName="default.html";c.randomFrame=false;c._FRAME_DIR="comps/AjaxUpload/frame/";c._INS_COUNT=1;c.prototype={_beforeInit:function(){var a=this;JC.log("AjaxUpload _beforeInit",new Date().getTime())},_initHanlderEvent:function(){var a=this;a.on("FrameLoad",function(f){var b=a._model.frame().prop("contentWindow");if(!(b&&b.initPage)){return}b.initPage(a,a._model)});a.on("ERR_FILE_EXT",function(f,b){a._view.errFileExt(b);a._view.updateChange()});a.on("BeforeUpload",function(b){a._view.beforeUpload()});a.on("UploadDone",function(k,l){JC.log(l);var b=false,i=l;try{typeof l=="string"&&(l=d.parseJSON(l))}catch(j){l={};b=true}if(b){a._view.errFatalError(i);a._view.updateChange()}else{if(l.errorno){a._view.errUpload(l);a._view.updateChange()}else{a._view.updateChange(l)}a._model.cauUploadDoneCallback()&&a._model.cauUploadDoneCallback().call(a,l,a._model.selector(),a._model.frame())}});a.on("AUUpdateLayout",function(i,j,h,b){a._view.updateLayout(j,h,b)})},_inited:function(){var a=this;JC.log("AjaxUpload _inited",new Date().getTime());a._view.loadFrame();c.getInstance(a._model.frame(),a);a.trigger("AUInited")},update:function(a){var b=this;d(b._view).trigger("UpdateDefaultStatus");a&&b.trigger("UploadDone",[a]);return this}};BaseMVC.buildModel(c);c.Model._instanceName="AjaxUpload";c.Model.prototype={init:function(){JC.log("AjaxUpload.Model.init:",new Date().getTime())},cauStyle:function(){return this.attrProp("cauStyle")},cauButtonText:function(){return this.attrProp("cauButtonText")},cauUrl:function(){return this.attrProp("cauUrl")},cauFileExt:function(){return this.stringProp("cauFileExt")},cauFileName:function(){return this.attrProp("cauFileName")},cauLabelKey:function(){return this.attrProp("cauLabelKey")||"name"},cauValueKey:function(){return this.attrProp("cauValueKey")||"url"},cauStatusLabel:function(){return this.selectorProp("cauStatusLabel")},cauDisplayLabel:function(){return this.selectorProp("cauDisplayLabel")},cauDisplayLabelCallback:function(){return this.callbackProp("cauDisplayLabelCallback")},cauUploadDoneCallback:function(){return this.callbackProp("cauUploadDoneCallback")},cauValue:function(h){var j=this,i=j.cauDisplayLabel(),a="";if(typeof h!="undefined"){var b=h.data[j.cauValueKey()];a=h.data[j.cauLabelKey()];j.selector().val(b)}if(j.cauDisplayLabelCallback()){a=j.cauDisplayLabelCallback().call(j.selector(),h)}else{a=printf('<a href="{0}" class="green js_auLink" target="_blank">{1}</a>',b,a)}i&&i.length&&i.html(a);return j.selector().val()},framePath:function(){var b=this.attrProp("cauFrameFileName")||c.frameFileName,a=printf("{0}{1}{2}",JC.PATH,c._FRAME_DIR,b);this.randomFrame()&&(a=addUrlParams(a,{rnd:new Date().getTime()}));return a},randomFrame:function(){var a=c.randomFrame;this.selector().is("[cauRandomFrame]")&&(a=this.boolProp("cauRandomFrame"));return a},frame:function(){if(!this._iframe){var a=c.frameTpl;if(this.selector().is("[cauFrameScriptTpl]")){a=scriptContent(parentSelector(this.selector(),this.selector().attr("cauFrameScriptTpl")))}this._iframe=d(c.frameTpl)}return this._iframe}};BaseMVC.buildView(c);c.View.prototype={init:function(){JC.log("AjaxUpload.View.init:",new Date().getTime());var a=this;d(a).on("UpdateDefaultStatus",function(g){var b=a._model.cauStatusLabel(),h=a._model.cauDisplayLabel();a.updateChange();b&&b.length&&b.hide();h&&h.length&&h.hide()})},loadFrame:function(){var f=this,a=f._model.framePath(),b=f._model.frame();JC.log(a);b.attr("src",a);b.on("load",function(){d(f).trigger("TriggerEvent","FrameLoad")});f._model.selector().before(b)},beforeUpload:function(){var b=this,a=b._model.cauStatusLabel();JC.log("AjaxUpload view#beforeUpload",new Date().getTime());this.updateChange(null,true);if(a&&a.length){b._model.selector().hide();b._model.frame().hide();a.show()}},updateChange:function(h,b){var j=this,a=j._model.cauStatusLabel(),i=j._model.cauDisplayLabel();if(a&&a.length&&!b){j._model.selector().show();j._model.frame().show();a.hide()}if(i&&i.length){i.html("")}j._model.selector().val("");if(h&&("errorno" in h)&&!h.errorno){j._model.cauValue(h);if(i&&i.length){j._model.selector().hide();j._model.frame().hide();i.show();return}}},updateLayout:function(g,b,a){if(!(g&&b)){return}var h=this;JC.log("AjaxUpload @event UpdateLayout",new Date().getTime(),g,b);h._model.frame().css({width:g+"px",height:b+"px"})},errUpload:function(g){var h=this,b=h._model.callbackProp("cauUploadErrCallback");if(b){b.call(h._model.selector(),g,h._model.frame())}else{var a=g&&g.errmsg?g.errmsg:"上传失败, 请重试!";JC.Dialog?JC.Dialog.alert(a,1):alert(a)}},errFileExt:function(b){var h=this,g=h._model.callbackProp("cauFileExtErrCallback");if(g){g.call(h._model.selector(),h._model.cauFileExt(),b,h._model.frame())}else{var a=printf('类型错误, 允许上传的文件类型: {0} <p class="auExtErr" style="color:red">{1}</p>',h._model.cauFileExt(),b);JC.Dialog?JC.Dialog.alert(a,1):alert(a)}},errFatalError:function(g){var h=this,b=h._model.callbackProp("cauFatalErrorCallback");if(b){b.call(h._model.selector(),g,h._model.frame())}else{var a=printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',g);JC.Dialog?JC.Dialog.alert(a,1):alert(a)}}};BaseMVC.build(c);c.frameTpl=printf('<iframe src="about:blank" frameborder="0" class="AUIframe" style="{0}"></iframe>',"width: 84px; height: 24px;cursor: pointer; vertical-align: middle;");d(document).ready(function(){c.autoInit&&c.init()})}(jQuery));