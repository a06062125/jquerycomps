(function(b){window.Suggest=JC.Suggest=a;function a(e){e&&(e=b(e));if(a.getInstance(e)){return a.getInstance(e)}a.getInstance(e,this);a._allIns.push(this);this._model=new d(e);this._view=new c(this._model);this._init()}a.prototype={_init:function(){var e=this;b([e._view,e._model]).on("BindEvent",function(f,h,g){e.on(h,g)});b([e._view,e._model]).on("TriggerEvent",function(f,h,g){e.trigger(h,[g])});e._view.init();e._model.init();e.selector().attr("autocomplete","off");e._initActionEvent();e.trigger("SuggestInited");return e},update:function(f,g){var e=this;typeof g=="undefined"&&(g=f);if(e._model.sugdatafilter()){g=e._model.sugdatafilter().call(this,g)}if(g&&g.q){e._model.cache(g.q,g)}this._view.update(g)},show:function(){this._view.show();return this},hide:function(){this._view.hide();return this},selector:function(){return this._model.selector()},layout:function(){return this._model.layout()},on:function(f,e){b(this).on(f,e);return this},trigger:function(f,e){b(this).trigger(f,e);return this},_initActionEvent:function(){var e=this;e.on("SuggestUpdate",e.update);e.on("SuggestInited",function(f){if(e._model.suginitedcallback()){e._model.suginitedcallback().call(e)}});e._model.selector().on("keyup",function(h){var f=b(this),j=f.val().trim(),i=h.keyCode,g=f.data("IgnoreTime");if(g&&(new Date().getTime()-g)<300){return}JC.log("keyup",j,new Date().getTime(),i);if(i){switch(i){case 38:case 40:h.preventDefault();case 37:case 39:return;case 27:e.hide();return}}if(!j){e.update();return}if(!e._model.layout().is(":visible")){if(e._model.cache(j)){e.update(e._model.cache(j));return}}if(e._model.preValue===j){return}e._model.preValue=j;if(e._model.cache(j)){e.update(e._model.cache(j));return}JC.log(j);if(e._model.sugqueryinterval()){if(e._model.timeout){clearTimeout(e._model.timeout)}e._model.timeout=setTimeout(function(){e._model.getData(j)},e._model.sugqueryinterval())}else{e._model.getData(j)}});e._model.selector().on("blur",function(f){e._model.timeout&&clearTimeout(e._model.timeout)});e._model.selector().on("keydown",function(g){var k=g.keyCode,f=b(this),l,i,j=e._model.items(),h;k==38&&(i=true);JC.log("keyup",new Date().getTime(),k);switch(k){case 38:case 40:l=e._model.nextIndex(i);if(l>=0&&l<j.length){g.preventDefault();h=b(j[l]);e._model.selectedIdentifier(h);e.selector().val(e._model.getKeyword(h));return}break;case 9:e.hide();return;case 13:e.hide();f.data("IgnoreTime",new Date().getTime());e._model.sugprevententer()&&g.preventDefault();break}});b(e._model.layout()).delegate(".js_sugItem","mouseenter",function(f){e._model.selectedIdentifier(b(this),true)});b(e._model.layout()).delegate(".js_sugItem","mouseleave",function(f){b(this).removeClass("active")});e.selector().on("click",function(f){f.stopPropagation();e.selector().trigger("keyup");a._hideOther(e)});b(e._model.layout()).delegate(".js_sugItem","click",function(g){var f=b(this),h=e._model.getKeyword(f);e.selector().val(h);e.hide();e.trigger("SuggestSelected",[f]);e._model.sugselectedcallback()&&e._model.sugselectedcallback().call(e,h)});if(e._model.sugautoposition()){b(window).on("resize",function(){if(e._model.layout().is(":visible")){e._view.show()}})}}};a.getInstance=function(e,f){if(typeof e=="string"&&!/</.test(e)){e=b(e)}if(!(e&&e.length)||(typeof e=="string")){return}typeof f!="undefined"&&e.data("SuggestInstace",f);return e.data("SuggestInstace")};a.isSuggest=function(e){var f;e&&(e=b(e)).length&&(f=e.is("[sugurl]")||e.is("sugstaticdatacb"));return f};a.autoInit=true;a.layoutTpl="";a.dataFilter;a._allIns=[];a._hideOther=function(g){for(var f=0,e=a._allIns.length;f<e;f++){if(a._allIns[f]._model._id!=g._model._id){a._allIns[f].hide()}}};function d(e){this._selector=e;this._id="Suggest_"+new Date().getTime()}d.prototype={init:function(){return this},selector:function(){return this._selector},suglayouttpl:function(){var e=this,g=a.layoutTpl||e.layoutTpl,f;(f=e.selector().attr("suglayouttpl"))&&(g=f);return g},layoutTpl:'<dl class="sug_layout js_sugLayout" style="display:none;"></dl>',layout:function(){var e=this;!e._layout&&e.selector().is("[suglayout]")&&(e._layout=parentSelector(e.selector(),e.selector().attr("suglayout")));!e._layout&&(e._layout=b(e.suglayouttpl()),e._layout.hide(),e._layout.appendTo(document.body),(e._sugautoposition=true));!e._layout.hasClass("js_sugLayout")&&e._layout.addClass("js_sugLayout");if(e.sugwidth()){e._layout.css({width:e.sugwidth()+"px"})}e._layout.css({width:e._layout.width()+e.sugoffsetwidth()+"px"});return e._layout},sugautoposition:function(){this.layout().is("sugautoposition")&&(this._sugautoposition=parseBool(this.layout().attr("sugautoposition")));return this._sugautoposition},sugwidth:function(){this.selector().is("[sugwidth]")&&(this._sugwidth=parseInt(this.selector().attr("sugwidth")));!this._sugwidth&&(this._sugwidth=this.sugplaceholder().width());return this._sugwidth},sugoffsetleft:function(){this.selector().is("[sugoffsetleft]")&&(this._sugoffsetleft=parseInt(this.selector().attr("sugoffsetleft")));!this._sugoffsetleft&&(this._sugoffsetleft=0);return this._sugoffsetleft},sugoffsettop:function(){this.selector().is("[sugoffsettop]")&&(this._sugoffsettop=parseInt(this.selector().attr("sugoffsettop")));!this._sugoffsettop&&(this._sugoffsettop=0);return this._sugoffsettop},sugoffsetwidth:function(){this.selector().is("[sugoffsetwidth]")&&(this._sugoffsetwidth=parseInt(this.selector().attr("sugoffsetwidth")));!this._sugoffsetwidth&&(this._sugoffsetwidth=0);return this._sugoffsetwidth},_dataCallback:function(e){b(this).trigger("TriggerEvent",["SuggestUpdate",e])},sugdatacallback:function(){var e=this;this.selector().is("[sugdatacallback]")&&(this._sugdatacallback=this.selector().attr("sugdatacallback"));!this._sugdatacallback&&(this._sugdatacallback=e._id+"_cb");!window[this._sugdatacallback]&&(window[this._sugdatacallback]=function(f){e._dataCallback(f)});return this._sugdatacallback},sugurl:function(e){this.selector().is("[sugurl]")&&(this._sugurl=this.selector().attr("sugurl"));!this.selector().is("[sugurl]")&&(this._sugurl="?word={0}&callback={1}");this._sugurl=printf(this._sugurl,e,this.sugdatacallback());return this._sugurl},sugneedscripttag:function(){this._sugneedscripttag=true;this.selector().is("[sugneedscripttag]")&&(this._sugneedscripttag=parseBool(this.selector().attr("sugneedscripttag")));return this._sugneedscripttag},getData:function(i){var f=this,g=this.sugurl(i),h,e="script_"+f._id;JC.log(g,new Date().getTime());if(this.sugneedscripttag()){b("#"+e).remove();h=printf('<script id="{1}" src="{0}"><\/script>',g,e);b(h).appendTo(document.body)}else{b.get(g,function(j){j=b.parseJSON(j);f._dataCallback(j)})}},cache:function(e,f){this._cache=this._cache||{};typeof f!="undefined"&&(this._cache[e]=f);return this._cache[e]},sugselectedcallback:function(){var e=this;this.selector().is("[sugselectedcallback]")&&(this._sugselectedcallback=this.selector().attr("sugselectedcallback"));return this._sugselectedcallback?window[this._sugselectedcallback]:null},suginitedcallback:function(){var e=this;this.selector().is("[suginitedcallback]")&&(this._suginitedcallback=this.selector().attr("suginitedcallback"));return this._suginitedcallback?window[this._suginitedcallback]:null},sugdatafilter:function(){var e=this;this.selector().is("[sugdatafilter]")&&(this._sugdatafilter=this.selector().attr("sugdatafilter"));this._sugdatafilter=this._sugdatafilter||a.dataFilter;return this._sugdatafilter?window[this._dataCallback]:null},sugqueryinterval:function(){this.selector().is("[sugqueryinterval]")&&(this._sugqueryinterval=parseInt(this.selector().attr("sugqueryinterval")));this._sugqueryinterval=this._sugqueryinterval||200;return this._sugqueryinterval},sugprevententer:function(){var e;this.selector().is("[sugprevententer]")&&(e=parseBool(this.selector().attr("sugprevententer")));return e},timeout:null,preValue:null,keyindex:-1,nextIndex:function(f){var g=this.items(),e=g.length;if(f){if(this.keyindex<=0){this.keyindex=e-1}else{this.keyindex--}}else{if(this.keyindex>=e-1){this.keyindex=0}else{this.keyindex++}}return this.keyindex},items:function(){return this.layout().find(".js_sugItem")},selectedIdentifier:function(f,e){this._preSelected&&this._preSelected.removeClass("active");f.addClass("active");e&&(this.keyindex=parseInt(f.attr("keyindex")));this._preSelected=f},getKeyword:function(e){var g=e.attr("keyword");try{g=decodeURIComponent(g)}catch(f){}return g},currentData:function(e){typeof e!="undefined"&&(this._currentData=e);return this._currentData},sugsubtagname:function(){var f="dd",e;(e=this.selector().attr("sugsubtagname"))&&(f=e);return f},sugplaceholder:function(){var e=this.selector();this.selector().is("[sugplaceholder]")&&(e=parentSelector(this.selector(),this.selector().attr("sugplaceholder")));return e}};function c(e){this._model=e}c.prototype={init:function(){return this},show:function(){var e=this;b(this).trigger("TriggerEvent",["SuggestBeforeShow"]);this._model.layout().css("z-index",window.ZINDEX_COUNT++);this.autoposition();this._model.layout().show();setTimeout(function(){e._model.layout().show()},10);b(this).trigger("TriggerEvent",["SuggestShow"])},autoposition:function(){if(!this._model.sugautoposition()){return}var e=this,f=e._model.sugplaceholder().offset(),g=e._model.sugplaceholder().height();e._model.layout().css({left:f.left+e._model.sugoffsetleft()+"px",top:f.top+e._model.sugoffsettop()+g+"px"})},hide:function(){this._model.layout().hide();this.reset();b(this).trigger("TriggerEvent",["SuggestHide"])},update:function(g){var f=this,e=[],o,n,m,h=f._model.sugsubtagname();if(!(g&&g.s&&g.s.length)){f.hide();return}for(var l=0,k=g.s.length;l<k;l++){n=g.s[l],m=n,o=g.q||"";if(n.indexOf(o)>-1){m=m.slice(o.length);m="<b>"+m+"</b>"}else{o=""}e.push(printf('<{4} keyword="{2}" keyindex="{3}" class="js_sugItem">{0}{1}</{4}>',o,m,encodeURIComponent(n),l,h))}f._model.layout().html(e.join(""));JC.log("suggest update");this.reset();f._model.currentData(g);b(this).trigger("TriggerEvent",["SuggestUpdated"]);f.show()},reset:function(){JC.log("suggest reset");this._model.keyindex=-1;this._model.layout().find(".js_sugItem").removeClass("active");b(this).trigger("TriggerEvent",["SuggestReset"])}};b(document).delegate("input[type=text]","focus",function(f){var e=b(this),g=a.getInstance(e);if(g||!a.isSuggest(e)||!a.autoInit){return}JC.log("Suggest input fined:",e.attr("name"),new Date().getTime());g=new a(e)});b(document).on("click",function(e){b("dl.js_sugLayout, div.js_sugLayout").hide()})}(jQuery));